name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  infra-deploy:
    environment: dev-db-backups
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.0.0
        with:
          version: 10.10.0

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: v22.14.0
          cache: "pnpm"

      - name: Install deps
        run: pnpm install

      - name: Prisma generate
        run: |
          cd packages/db
          pnpm db:generate

      - name: Preview Deploy
        env:
          DATABASE_URL: "postgresql://${{ secrets.PGUSER }}:${{ secrets.PGPASSWORD }}@${{ secrets.PGHOST }}:${{ secrets.PGPORT }}/preview-${{ github.event.pull_request.number }}?sslmode=no-verify&schema=public"
        run: |
          cd infra
          export DATABASE_URL
          export PR_NUMBER=${{ github.event.pull_request.number }}
          pnpm sst deploy --stage preview-${{ github.event.pull_request.number }}

